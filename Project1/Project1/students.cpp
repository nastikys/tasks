#include "students.h"
#include <fstream>
#include <iostream>
#include <algorithm>

#define MAX_SIZE 100000

void Students::LoadCSV(const string& _filename, char _sep)//?????? ???????? ??? - ???????????? ???? ????.???????? ?? ???????? ???
{
	sep = _sep;//??????????? ? ????? , 
	ifstream inputFile(_filename);
	ReserveSize(inputFile);//??????????? ?????? ??? ???????
	string line;
	int numOfLine = 1;//????? ?????? ???????. ????? ??????? ??????? = ???? ?????
	while (!inputFile.eof() && potok.size() < sizeTable)//???? ?? ?????? ?? ????? ????? ? ?????? ??????? ?????? ??????? ??????? ??? ??????
	{
		getline(inputFile, line);//?????? ???????
		++numOfLine;//????? ??????? ?????
		ParseStudent(line);//???????? ??????? 
		if (!potok[potok.size()-1].IsValid()) // ???????? ??????? ???????? ?? ???????.???? ??????? ?? ????????(? ?? ??????? - ?????? ???? ??????????? ????????.
		{
			cout << "File is invalid! Line - " << numOfLine << endl;
			exit(-1);
		}
	}
	inputFile.close();//????????? ???? ????? ????????? ???? ?????????
}//?????? -? ??????? ????? ??????????? ??? ??????????? ??????

void Students::SaveCSV(const string & _filename, char _sep)//?? ?? ????? ???
{
	sep = _sep;
	int		fellows = 0.4 * potok.size();
	int		totalFellows = 0;
	ofstream outputFile(_filename);
	for (auto i : potok)
	{
		if (totalFellows >= fellows)
			break;
		if (!i.IsContract())
		{
			outputFile << i.DumpCSV(sep) << endl;
			++totalFellows;
		}
	}
	outputFile.close();
}

void Students::PrintCSV(char _sep)//????? ?? ????? ??????? ? ??? ????????? ???????????? ????????
{
	sep						= _sep;
	int		fellows			= 0.4 * potok.size();//??? ??????????? ???????????? - ??????? ??????????? 40 ??
	int		totalFellows	= 0;//??????? ???????????? ?? ????? ????
	double	minAvgValue		= potok[0].AvgRatings();//????? ??????? ??? ??????? ????????.????? ??????? ???????? ???????? ???????? ??? ????? ??????
	for (auto i : potok)//(int i=0;i<potok.size();i++) potok[i] ?????? ?????? i.
	{
		if (totalFellows >= fellows)//???? ???????? ???? ???????????? ??????????? ??? ???????????
			break;//????? ?? ?????
		if (!i.IsContract())//???? ?????????
		{
			cout << i.DumpCSV(sep) << endl;// ????? ?????????? ??????? ??????? ??? ???????
			minAvgValue = i.AvgRatings();// ????????? ??? ??????? ???????? ( ???? ?? ???????? ? ???)
			++totalFellows;//??????????? ??????????? ???????? ???????????? ?? 1
		}
	}
	cout << "Min Avg value:" << minAvgValue << endl;
}

void Students::PrintAllUsers(char _sep)//????? ???? ????????? ? ?? ????
{
	sep = _sep;
	for (auto i : potok)
	{
		cout << i.DumpCSV(sep) << endl;
	}
}

void Students::SortStudentsByRating()//????????? ?????? ?? ?????? ?? ????? ?? ???????????
{
	sort(potok.begin(), potok.end(), StudentsRatingComparer);// ????????? ?? ??????? ??????? ????
}

void Students::ReserveSize(ifstream& _inputFile)
{
	string line;
	if (!_inputFile.eof())//???? ?? ???????
	{
		getline(_inputFile, line);//??????? ???????
	}
	else
	{
		cout << "File is empty!" << endl;
	}

	try // ????????? ?????????? ??? ???????????? ????. ?????? ?????? ??????? ? ??????(??????????? ????????)
	{
		sizeTable = stoi(line); // ???? ?????????? ??????- ???
		potok.reserve(sizeTable);//?????? ?????? ??????? ?? ????? ?????????
	}
	catch (const invalid_argument& _exc) // ???? ? ???? ??????(??? ????? ? 1 ??????)
	{
		sizeTable = MAX_SIZE;
		cout << "Warning! Unknown size";
		ParseStudent(line);//??????
	}
}

void Students::ParseStudent(const string& line) //??????? ?????????
{
	Student st;//??????? ????????
	try
	{
		st.ParseLine(line, sep);
		potok.emplace_back(st);//?????????? ? ????? ??????? ??????? ????? ?????? 
	}
	catch (const invalid_argument& _exc)
	{
		cout << "Error! Invalid line:" << line << endl;
		exit(-1);
	}
}
